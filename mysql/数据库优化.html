<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2022年MySQL最新面试题 - MySQL数据库优化 | 漫步coding</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="漫步coding的博客">
    
    <link rel="preload" href="/project/assets/css/0.styles.2a1e5e66.css" as="style"><link rel="preload" href="/project/assets/js/app.34004228.js" as="script"><link rel="preload" href="/project/assets/js/2.eeb24f79.js" as="script"><link rel="preload" href="/project/assets/js/43.5eef4375.js" as="script"><link rel="prefetch" href="/project/assets/js/10.c2b9e207.js"><link rel="prefetch" href="/project/assets/js/11.a59b52a4.js"><link rel="prefetch" href="/project/assets/js/12.f74f8d2f.js"><link rel="prefetch" href="/project/assets/js/13.1cdc54f3.js"><link rel="prefetch" href="/project/assets/js/14.54466736.js"><link rel="prefetch" href="/project/assets/js/15.03163b85.js"><link rel="prefetch" href="/project/assets/js/16.932067a4.js"><link rel="prefetch" href="/project/assets/js/17.ba11dbdc.js"><link rel="prefetch" href="/project/assets/js/18.45216f93.js"><link rel="prefetch" href="/project/assets/js/19.f5fa6b10.js"><link rel="prefetch" href="/project/assets/js/20.6633ae84.js"><link rel="prefetch" href="/project/assets/js/21.4eb648f8.js"><link rel="prefetch" href="/project/assets/js/22.cc2b6b3b.js"><link rel="prefetch" href="/project/assets/js/23.362f3e68.js"><link rel="prefetch" href="/project/assets/js/24.d072fdb4.js"><link rel="prefetch" href="/project/assets/js/25.0a77d255.js"><link rel="prefetch" href="/project/assets/js/26.6e1e0f2a.js"><link rel="prefetch" href="/project/assets/js/27.f9aca207.js"><link rel="prefetch" href="/project/assets/js/28.e92a4d37.js"><link rel="prefetch" href="/project/assets/js/29.4e1dcaab.js"><link rel="prefetch" href="/project/assets/js/3.dc393602.js"><link rel="prefetch" href="/project/assets/js/30.f9d56e6a.js"><link rel="prefetch" href="/project/assets/js/31.fa904c4a.js"><link rel="prefetch" href="/project/assets/js/32.30400fc3.js"><link rel="prefetch" href="/project/assets/js/33.a1ef6a50.js"><link rel="prefetch" href="/project/assets/js/34.8fb009a7.js"><link rel="prefetch" href="/project/assets/js/35.2a6fda65.js"><link rel="prefetch" href="/project/assets/js/36.294749cf.js"><link rel="prefetch" href="/project/assets/js/37.20683a66.js"><link rel="prefetch" href="/project/assets/js/38.ea5cb3f9.js"><link rel="prefetch" href="/project/assets/js/39.ccdeead5.js"><link rel="prefetch" href="/project/assets/js/4.f876ad59.js"><link rel="prefetch" href="/project/assets/js/40.48a6a4cf.js"><link rel="prefetch" href="/project/assets/js/41.8ef2ff9f.js"><link rel="prefetch" href="/project/assets/js/42.ddbb9271.js"><link rel="prefetch" href="/project/assets/js/44.4a1ccf61.js"><link rel="prefetch" href="/project/assets/js/45.cac19bc8.js"><link rel="prefetch" href="/project/assets/js/46.c5fcc280.js"><link rel="prefetch" href="/project/assets/js/47.5c69ad7c.js"><link rel="prefetch" href="/project/assets/js/48.2f6563d7.js"><link rel="prefetch" href="/project/assets/js/49.a5d08db0.js"><link rel="prefetch" href="/project/assets/js/5.18c5236f.js"><link rel="prefetch" href="/project/assets/js/50.a19adac6.js"><link rel="prefetch" href="/project/assets/js/51.7f17d99c.js"><link rel="prefetch" href="/project/assets/js/52.735ae462.js"><link rel="prefetch" href="/project/assets/js/53.4fa31046.js"><link rel="prefetch" href="/project/assets/js/54.d9a61a57.js"><link rel="prefetch" href="/project/assets/js/55.fdc8fcc9.js"><link rel="prefetch" href="/project/assets/js/56.1622f292.js"><link rel="prefetch" href="/project/assets/js/57.bb9be80d.js"><link rel="prefetch" href="/project/assets/js/58.e6e338fc.js"><link rel="prefetch" href="/project/assets/js/59.56a9e2c0.js"><link rel="prefetch" href="/project/assets/js/6.e86df8f9.js"><link rel="prefetch" href="/project/assets/js/60.68726952.js"><link rel="prefetch" href="/project/assets/js/61.926ef892.js"><link rel="prefetch" href="/project/assets/js/62.0d84d4c8.js"><link rel="prefetch" href="/project/assets/js/63.4a857a88.js"><link rel="prefetch" href="/project/assets/js/64.7348fd03.js"><link rel="prefetch" href="/project/assets/js/7.9ebead10.js"><link rel="prefetch" href="/project/assets/js/8.06f9a33b.js"><link rel="prefetch" href="/project/assets/js/9.882160f3.js">
    <link rel="stylesheet" href="/project/assets/css/0.styles.2a1e5e66.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/project/" class="home-link router-link-active"><!----> <span class="site-name">漫步coding</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/project/" aria-current="page" class="sidebar-link">首页</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>2022年MySQL最新面试题</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/project/mysql/前言.html" class="sidebar-link">前言</a></li><li><a href="/project/mysql/数据库基础知识.html" class="sidebar-link">数据库基础知识</a></li><li><a href="/project/mysql/索引.html" class="sidebar-link">索引</a></li><li><a href="/project/mysql/存储引擎.html" class="sidebar-link">存储引擎</a></li><li><a href="/project/mysql/事务.html" class="sidebar-link">事务</a></li><li><a href="/project/mysql/数据库锁.html" class="sidebar-link">数据库锁</a></li><li><a href="/project/mysql/视图.html" class="sidebar-link">视图</a></li><li><a href="/project/mysql/触发器.html" class="sidebar-link">触发器</a></li><li><a href="/project/mysql/常用SQL语句.html" class="sidebar-link">常用SQL语句</a></li><li><a href="/project/mysql/SQL优化.html" class="sidebar-link">SQL优化</a></li><li><a href="/project/mysql/数据库优化.html" class="active sidebar-link">数据库优化</a></li><li><a href="/project/mysql/部署和运维.html" class="sidebar-link">部署和运维</a></li><li><a href="/project/mysql/MySQL最新面试题及思维导图.html" class="sidebar-link">MySQL最新面试题及思维导图</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>2022年Redis最新面试题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>LeetCode高频算法面试题</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>IDEA系列教程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>开发工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>公众号</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h4 id="_0、概要"><a href="#_0、概要" class="header-anchor">#</a> 0、概要</h4> <ul><li>1、为什么要优化</li> <li>2、数据库结构优化</li> <li>3、MySQL数据库cpu飙升到500%的话他怎么处理？</li> <li>4、大表怎么优化？某个表有近千万数据，CRUD比较慢，如何优化？</li> <li>5、垂直分表的适用场景和优缺点</li> <li>6、水平分表的适用场景和优缺点</li> <li>7、MySQL的复制原理以及流程</li> <li>8、读写分离有哪些解决方案？</li> <li>9、数据表损坏的修复方式有哪些？</li></ul> <h4 id="_1、为什么要优化数据库"><a href="#_1、为什么要优化数据库" class="header-anchor">#</a> 1、为什么要优化数据库</h4> <p>出现概率: ★</p> <p>当然是让我们的数据库更稳、更快、更持久了。</p> <h4 id="_2、数据库结构优化"><a href="#_2、数据库结构优化" class="header-anchor">#</a> 2、数据库结构优化</h4> <p>出现概率: ★★★</p> <p>其实一般业务开发中, 这个关注的不多，估计是一些偏极客的团队关注的比较多些</p> <p>使表占用尽量少的磁盘空间。减少磁盘I/O次数及读取数据量是提升性能的基础原则。表越小，数据读写处理时则需要更少的内存，同时，小表的索引占用也相对小，索引处理也更加快速。</p> <p>MySQL支持不同类型的存储引擎和行格式，针对不同类型，业务需求的表应该设置合适的存储引擎及索引方法。表设置建议如下：</p> <p>表列</p> <ul><li>为列选择最合适（通常最小）的数据类型。MySQL 具有许多不同列类型以最大化的减少磁盘和内存占用。例如，使用足够小的整型来表示小范围的小整型数据。MEDIUMINT 通常是一个很好的选择，它只占用INT 25%，甚至更小的空间。</li> <li>如果可能，则将列声明为NOT NULL。声明为NOT NULL，使得优化器能够更好的使用索引，并避免了判断NULL的处理，这使得SQL 操作执行的更加快速。同时也为每列节省了1 bit的空间。如果确实需要使用NULL 值，那么也应该避免所有列都允许NULL。</li> <li>InnoDB 表默认使用动态类型(DYNAMIC )的行格式。可以通过设置默认行格式（innodb_default_row_format），或者在表定义（CREATE TABLE 或 ALTER TABLE ）中声明使用的行格式。</li></ul> <p>行格式</p> <p>压缩类型的行格式，包括COMPACT, DYNAMIC, 和 COMPRESSED，对于特定操作，减少了存储空间占用，但是增加了CPU计算能力使用。如果主要的负载在缓存命中率及磁盘读写速度，那么这种格式将能够提升数据库反应速度。如果是极端情况负载受限于CPU性能，那么使用这种格式则会降低数据库性能。</p> <p>压缩行格式也会对使用utf8mb3 或者 utf8mb4格式的变长CHAR 类型列存储进行优化处理。对于使用ROW_FORMAT=REDUNDANT, CHAR(N) 定义的表，每个列值最多占用 N × 个字节长度。许多语言可以使用但字节的utf8格式表示，所以规定那个长度的定义通常会造成空间浪费。压缩行格式定义下，InnoDB 会每一个列值分配一个N 到 N× 个字节的空间。</p> <h4 id="_3、mysql数据库cpu飙升到500-的话-应该怎么处理"><a href="#_3、mysql数据库cpu飙升到500-的话-应该怎么处理" class="header-anchor">#</a> 3、MySQL数据库cpu飙升到500%的话, 应该怎么处理？</h4> <p>出现概率: ★★★</p> <p>当 cpu 飙升到 500%时，先用操作系统命令 top 命令观察是不是 mysqld 占用导致的，如果不是，找出占用高的进程，并进行相关处理。</p> <p>如果是 mysqld 造成的， <code>show processlist</code>，看看里面跑的 session 情况，是不是有消耗资源的 sql 在运行。找出消耗高的 sql，看看执行计划是否准确， index 是否缺失，或者实在是数据量太大造成。</p> <p>一般来说，肯定要 kill 掉这些线程(同时观察 cpu 使用率是否下降)，等进行相应的调整(比如说加索引、改 sql、改内存参数)之后，再重新跑这些 SQL。</p> <p>也有可能是每个 sql 消耗资源并不多，但是突然之间，有大量的 session 连进来导致 cpu 飙升，这种情况就需要跟应用一起来分析为何连接数会激增，再做出相应的调整，比如说限制连接数等</p> <p><code>show full processlist</code> 可以看到所有链接的情况，但是大多链接的 state 其实是 Sleep 的，这种的其实是空闲状态，没有太多查看价值</p> <p>我们要观察的是有问题的，所以可以进行过滤：</p> <p>-- 查询非 Sleep 状态的链接，按消耗时间倒序展示，自己加条件过滤</p> <div class="language- extra-class"><pre class="language-text"><code>select id, db, user, host, command, time, state, info
from information_schema.processlist
where command != 'Sleep'
order by time desc 
</code></pre></div><p>总结:</p> <p>CPU报警：很可能是 SQL 里面有较多的计算导致的</p> <p>连接数超高：很可能是有慢查询，然后导致很多的查询在排队，排查问题的时候可以看到”事发现场“类似的 SQL 语句一大片，那么有可能是没有索引或者索引不好使，可以用：explain 分析一下 SQL 语句</p> <h4 id="_4、大表怎么优化-某个表有近千万数据-crud比较慢-如何优化"><a href="#_4、大表怎么优化-某个表有近千万数据-crud比较慢-如何优化" class="header-anchor">#</a> 4、大表怎么优化？某个表有近千万数据，CRUD比较慢，如何优化？</h4> <p>出现概率: ★★★</p> <p>千万级其实数量不大, CRUD比较慢, 可能要考虑磁盘、索引等问题.</p> <h4 id="_5、垂直分表的适用场景和优缺点"><a href="#_5、垂直分表的适用场景和优缺点" class="header-anchor">#</a> 5、垂直分表的适用场景和优缺点</h4> <p>出现概率: ★★★</p> <p>把主码和一些列放到一个表，然后把主码和另外的列放到另一个表中。</p> <p>如果一个表中某些列常用，而另外一些列不常用，则可以采用垂直分割，另外垂直分割可以使得数据行变小，一个数据页就能存放更多的数据，在查询时就会减少I/O次数。其缺点是需要管理冗余列，查询所有数据需要join操作</p> <p><img src="https://images.xiaozhuanlan.com/uploads/photo/2022/c1fb7391-0edf-43ea-8158-ddbe7896b177.png" alt=""></p> <p>垂直切分的优点：</p> <ul><li>解决业务系统层面的耦合，业务清晰</li> <li>与微服务的治理类似，也能对不同业务的数据进行分级管理、维护、监控、扩展等</li> <li>高并发场景下，垂直切分一定程度的提升IO、数据库连接数、单机硬件资源的瓶颈</li></ul> <p>缺点：</p> <ul><li>部分表无法join，只能通过接口聚合方式解决，提升了开发的复杂度</li> <li>分布式事务处理复杂</li> <li>依然存在单表数据量过大的问题（需要水平切分）</li></ul> <h4 id="_6、水平分表的适用场景和优缺点"><a href="#_6、水平分表的适用场景和优缺点" class="header-anchor">#</a> 6、水平分表的适用场景和优缺点</h4> <p>出现概率: ★★★</p> <p>水平切分分为库内分表和分库分表，是根据表内数据内在的逻辑关系，将同一个表按不同的条件分散到多个数据库或多个表中，每个表中只包含一部分数据，从而使得单个表的数据量变小，达到分布式的效果。如图所示：</p> <p><img src="https://images.xiaozhuanlan.com/uploads/photo/2022/68aeb856-d92f-4857-a695-8ca9e26ce0d0.png" alt=""></p> <p>水平切分的优点：</p> <ul><li>不存在单库数据量过大、高并发的性能瓶颈，提升系统稳定性和负载能力</li> <li>应用端改造较小，不需要拆分业务模块</li></ul> <p>缺点：</p> <ul><li>跨分片的事务一致性难以保证</li> <li>跨库的join关联查询性能较差</li> <li>数据多次扩展难度和维护量极大</li></ul> <h4 id="_7、mysql的复制原理以及流程"><a href="#_7、mysql的复制原理以及流程" class="header-anchor">#</a> 7、MySQL的复制原理以及流程</h4> <p>MySQL主从复制工作原理</p> <ul><li>在主库上把数据更高记录到二进制日志</li> <li>从库将主库的日志复制到自己的中继日志</li> <li>从库读取中继日志的事件，将其重放到从库数据中</li> <li>基本原理流程，3个线程以及之间的关联</li> <li>主：binlog线程——记录下所有改变了数据库数据的语句，放进master上的binlog中；</li> <li>从：io线程——在使用start slave 之后，负责从master上拉取 binlog 内容，放进自己的relay log中；</li> <li>从：sql执行线程——执行relay log中的语句；</li></ul> <p>复制过程</p> <ul><li>Binary log：主数据库的二进制日志</li> <li>Relay log：从服务器的中继日志</li> <li>第一步：master在每个事务更新数据完成之前，将该操作记录串行地写入到binlog文件中。</li> <li>第二步：salve开启一个I/O Thread，该线程在master打开一个普通连接，主要工作是binlog dump process。如果读取的进度已经跟上了master，就进入睡眠状态并等待master产生新的事件。I/O线程最终的目的是将这些事件写入到中继日志中。</li> <li>第三步：SQL Thread会读取中继日志，并顺序执行该日志中的SQL事件，从而与主数据库中的数据保持一致。</li></ul> <h4 id="_8、读写分离有哪些解决方案"><a href="#_8、读写分离有哪些解决方案" class="header-anchor">#</a> 8、读写分离有哪些解决方案？</h4> <p>读写分离是依赖于主从复制，而主从复制又是为读写分离服务的。因为主从复制要求slave不能写只能读（如果对slave执行写操作，那么show slave status将会呈现Slave_SQL_Running=NO，此时你需要按照前面提到的手动同步一下slave）。</p> <p>方案一</p> <ul><li>使用mysql-proxy代理</li> <li>优点：直接实现读写分离和负载均衡，不用修改代码，master和slave用一样的帐号，mysql官方不建议实际生产中使用</li> <li>缺点：降低性能， 不支持事务</li></ul> <p>方案二</p> <ul><li>使用AbstractRoutingDataSource+aop+annotation在dao层决定数据源。</li> <li>如果采用了mybatis， 可以将读写分离放在ORM层，比如mybatis可以通过mybatis plugin拦截sql语句，所有的insert/update/delete都访问master库，所有的select
都访问salve库，这样对于dao层都是透明。 plugin实现时可以通过注解或者分析语句是读写方法来选定主从库。不过这样依然有一个问题，
也就是不支持事务， 所以我们还需要重写一下DataSourceTransactionManager， 将read-only的事务扔进读库，
其余的有读有写的扔进写库。</li></ul> <p>方案三</p> <ul><li>使用AbstractRoutingDataSource+aop+annotation在service层决定数据源，可以支持事务.</li> <li>缺点：类内部方法通过this.xx()方式相互调用时，aop不会进行拦截，需进行特殊处理。</li></ul> <h4 id="_9、数据表损坏的修复方式有哪些"><a href="#_9、数据表损坏的修复方式有哪些" class="header-anchor">#</a> 9、数据表损坏的修复方式有哪些？</h4> <p>MySQL数据库出现表损坏, 特别是MyISAM表数据很大的时候。有三种方法，一种方法使用MySQL的repair table的sql语句，另一种方法是使用MySQL提供的myisamchk,，最后一种是mysqlcheck命令行工具。</p> <p>1)、repair table（建议方法，对MyISAM引擎表有用）</p> <div class="language- extra-class"><pre class="language-text"><code>check table tabTest;
</code></pre></div><p>如果出现的结果说Status是OK，则不用修复，如果有Error，可以用：</p> <div class="language- extra-class"><pre class="language-text"><code>repair table tabTest;
</code></pre></div><p>进行修复，修复之后可以在用check table命令来进行检查。在新版本的phpMyAdmin里面也可以使用check/repair的功能。</p> <p>2)、myisamchk（该工具必须运行在服务终止条件下，对MyISAM引擎表有用）。</p> <div class="language- extra-class"><pre class="language-text"><code>myisamchk tablename.MYI
</code></pre></div><p>进行检测。</p> <div class="language- extra-class"><pre class="language-text"><code>myisamchk -of tablename.MYI
</code></pre></div><p>网上说的其它方法：</p> <p>那么修复test表的方法为</p> <div class="language- extra-class"><pre class="language-text"><code>myisamchk -r -q /var/lib/mysql/db/test.MYI
</code></pre></div><p>如果修复全部表，用这个命令</p> <div class="language- extra-class"><pre class="language-text"><code>myisamchk -r -q /var/lib/mysql/db/*.MYI

</code></pre></div><p>3)、运行mysqlcheck命令行工具（该工具可以在服务运行状态下执行）</p> <p>检查一个库中的所有表：</p> <div class="language- extra-class"><pre class="language-text"><code>
$ mysqlcheck -c users -uroot -p

Enter password:

users.account                                 OK
users.alarm                                   OK\

</code></pre></div><p>也欢迎关注我的公众号: <code>漫步coding</code>, 回复: <code>mysql</code>免费获取最新Mysql面试题汇总(含答案)。 一起交流, 在coding的世界里漫步。</p> <p><img src="https://images.xiaozhuanlan.com/uploads/photo/2022/5cb0c91e-fd83-4a04-8df6-65fb602b3834.png" alt=""></p> <p>希望这篇文章可以帮助大家, 也希望大家都能找到找到的好工作。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/project/mysql/SQL优化.html" class="prev">
        SQL优化
      </a></span> <span class="next"><a href="/project/mysql/部署和运维.html">
        部署和运维
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/project/assets/js/app.34004228.js" defer></script><script src="/project/assets/js/2.eeb24f79.js" defer></script><script src="/project/assets/js/43.5eef4375.js" defer></script>
  </body>
</html>
